<html lang="en">
    <!DOCTYPE html>
<head>
<meta charset="UTF-8">
<title>Public Volunteer Dashboard</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    ul { list-style: none; padding: 0; }
    li { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; position: relative; }
    button { padding: 5px 10px; cursor: pointer; }
    .highlight { background-color: #d4edda; animation: fadeHighlight 3s; }
    @keyframes fadeHighlight { from { background-color: #d4edda; } to { background-color: white; } }
    .notification {
        position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
        padding: 10px 20px; border-radius: 5px; display: none;
    }
</style>
</head>
<body>
<h1>Available Donations</h1>
<ul id="donation-list">
    <li>No donations available at the moment.</li>
</ul>

<div id="notification" class="notification"></div>

<script>
const donationList = document.getElementById('donation-list');
const notification = document.getElementById('notification');

// Connect to WebSocket server
const ws = new WebSocket("ws://localhost:8765");

ws.onopen = () => console.log("‚úÖ Connected to WebSocket");
ws.onerror = err => console.error("‚ùå WebSocket error:", err);
ws.onclose = () => console.warn("‚ö†Ô∏è WebSocket closed");

// Handle incoming messages
ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log("üì© Received:", data);

    if (data.type === "new_donation") {
        addDonation(data);
        showNotification(`New donation: ${data.food_type} from ${data.restaurant}`);
    }

    if (data.type === "donation_accepted") {
        const item = donationList.querySelector(`li[data-id='${data.id}']`);
        if (item) item.remove();
        restorePlaceholderIfEmpty();
    }
};

// Add donation to dashboard
function addDonation(donation) {
    // Remove placeholder if present
    if (donationList.children.length === 1 &&
        donationList.children[0].textContent.includes("No donations")) {
        donationList.innerHTML = "";
    }

    const li = document.createElement('li');
    li.className = 'highlight';
    li.setAttribute('data-id', donation.id);
    li.innerHTML = `
        <strong>${donation.food_type}</strong> from <strong>${donation.restaurant}</strong><br>
        Quantity: ${donation.quantity}<br>
        Pay: ‚Çπ${donation.discounted_price}<br>
        Location: <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(donation.location)}" target="_blank">${donation.location}</a><br>
        <button onclick="acceptDonation(${donation.id}, this)">Accept</button>
    `;
    donationList.prepend(li);
}

// Accept donation
function acceptDonation(donationId, button) {
    // Simulate API call
    alert(`Donation ${donationId} accepted! Proceed to payment and pickup.`);
    
    // Remove from this dashboard
    const li = button.closest('li');
    if (li) li.remove();
    restorePlaceholderIfEmpty();

    // Notify "server" to broadcast removal to other dashboards (simulated)
    ws.send(JSON.stringify({ type: "donation_accepted", id: donationId }));
}

// Restore placeholder if no donations left
function restorePlaceholderIfEmpty() {
    if (donationList.children.length === 0) {
        const placeholder = document.createElement('li');
        placeholder.textContent = "No donations available at the moment.";
        donationList.appendChild(placeholder);
    }
}

// Show temporary notification
function showNotification(message) {
    notification.textContent = message;
    notification.style.display = "block";
    setTimeout(() => notification.style.display = "none", 1000);
}
</script>
</body>
</html>
